!function(){"use strict";if("undefined"==typeof etkm)return;const t=document.getElementById("etkm-upload-area"),e=document.getElementById("etkm-file-input"),n=document.getElementById("etkm-select-file"),a=document.getElementById("etkm-kits-list");let s,i="gallery",o=new Set;function r(e){e.name.endsWith(".zip")?e.size>etkm.maxFileSize?f(etkm.strings.fileTooLarge,"error"):function(e){const n=new FormData;n.append("action","etkm_upload_kit"),n.append("nonce",etkm.nonce),n.append("file",e);const a=t.querySelector(".etkm-upload-content"),s=t.querySelector(".etkm-upload-progress");a.style.display="none",s.style.display="block";const i=new XMLHttpRequest;i.upload.addEventListener("progress",function(t){t.lengthComputable&&c(t.loaded/t.total*100)}),i.addEventListener("load",function(){if(200===i.status)try{const t=JSON.parse(i.responseText);t.success?(f(t.data.message,"success"),l(),d()):(f(t.data.message||etkm.strings.uploadError,"error"),d())}catch(t){f(etkm.strings.uploadError,"error"),d()}else f(etkm.strings.uploadError,"error"),d()}),i.addEventListener("error",function(){f(etkm.strings.uploadError,"error"),d()}),i.open("POST",etkm.ajaxUrl),i.send(n)}(e):f(etkm.strings.invalidFile,"error")}function c(t){const e=document.querySelector(".etkm-progress-fill"),n=document.querySelector(".etkm-progress-text");e&&n&&(e.style.width=t+"%",n.textContent=Math.round(t)+"%")}function d(){const n=t.querySelector(".etkm-upload-content"),a=t.querySelector(".etkm-upload-progress");setTimeout(function(){n.style.display="block",a.style.display="none",c(0),e.value=""},1e3)}function l(){a.innerHTML='<div class="etkm-loading"><span class="spinner is-active"></span><p>Loading template kits...</p></div>',fetch(etkm.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"etkm_get_kits",nonce:etkm.nonce})}).then(t=>t.json()).then(t=>{t.success?function(t){if(0===t.length)return void(a.innerHTML='\n\t\t\t\t<div class="etkm-empty-state">\n\t\t\t\t\t<span class="dashicons dashicons-download"></span>\n\t\t\t\t\t<h3>No Template Kits Yet</h3>\n\t\t\t\t\t<p>Upload your first Elementor template kit to get started.</p>\n\t\t\t\t</div>\n\t\t\t');let e="";"gallery"===i?t.forEach(function(t){const n=o.has(t.name),a=t.preview?`<img src="${k(t.preview)}" alt="${k(t.display_name)}" loading="lazy">`:'<span class="dashicons dashicons-media-document etkm-placeholder-icon"></span>';e+=`\n\t\t\t\t\t<div class="etkm-gallery-card ${n?"selected":""}" data-filename="${k(t.name)}">\n\t\t\t\t\t\t<div class="etkm-card-preview">\n\t\t\t\t\t\t\t${a}\n\t\t\t\t\t\t\t<button type="button" class="etkm-add-image-btn" data-filename="${k(t.name)}">\n\t\t\t\t\t\t\t\t<span class="dashicons dashicons-format-image"></span>\n\t\t\t\t\t\t\t\t${t.preview?"Change Image":"Add Image"}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<div class="etkm-card-actions">\n\t\t\t\t\t\t\t\t<button type="button" class="button button-primary etkm-import-btn" data-filename="${k(t.name)}">\n\t\t\t\t\t\t\t\t\t<span class="dashicons dashicons-download"></span> Import\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t<button type="button" class="button button-secondary etkm-delete-btn" data-filename="${k(t.name)}">\n\t\t\t\t\t\t\t\t\t<span class="dashicons dashicons-trash"></span> Delete\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="etkm-card-info">\n\t\t\t\t\t\t\t<h3>${k(t.display_name)}</h3>\n\t\t\t\t\t\t\t<div class="etkm-card-meta">\n\t\t\t\t\t\t\t\t<span><span class="dashicons dashicons-calendar-alt"></span>${k(t.date)}</span>\n\t\t\t\t\t\t\t\t<span><span class="dashicons dashicons-media-archive"></span>${k(t.size)}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`}):t.forEach(function(t){e+=`\n\t\t\t\t\t<div class="etkm-kit-item" data-filename="${k(t.name)}">\n\t\t\t\t\t\t<div class="etkm-kit-info">\n\t\t\t\t\t\t\t<h3>${k(t.display_name)}</h3>\n\t\t\t\t\t\t\t<div class="etkm-kit-meta">\n\t\t\t\t\t\t\t\t<span><span class="dashicons dashicons-calendar-alt"></span>${k(t.date)}</span>\n\t\t\t\t\t\t\t\t<span><span class="dashicons dashicons-media-archive"></span>${k(t.size)}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="etkm-kit-actions">\n\t\t\t\t\t\t\t<button type="button" class="button etkm-add-image-btn-list" data-filename="${k(t.name)}">\n\t\t\t\t\t\t\t\t<span class="dashicons dashicons-format-image"></span> ${t.preview?"Change":"Add"} Image\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="button button-primary etkm-import-btn" data-filename="${k(t.name)}">\n\t\t\t\t\t\t\t\t<span class="dashicons dashicons-download"></span> Import\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="button etkm-delete-btn" data-filename="${k(t.name)}">\n\t\t\t\t\t\t\t\t<span class="dashicons dashicons-trash"></span> Delete\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`}),a.innerHTML=e,"gallery"===i&&document.querySelectorAll(".etkm-gallery-card").forEach(function(t){t.addEventListener("click",function(t){if(!t.target.closest(".etkm-import-btn")&&!t.target.closest(".etkm-delete-btn")&&!t.target.closest(".etkm-add-image-btn")){const t=this.dataset.filename;o.has(t)?(o.delete(t),this.classList.remove("selected")):(o.add(t),this.classList.add("selected"))}})}),document.querySelectorAll(".etkm-import-btn").forEach(function(t){t.addEventListener("click",p)}),document.querySelectorAll(".etkm-delete-btn").forEach(function(t){t.addEventListener("click",u)}),document.querySelectorAll(".etkm-add-image-btn").forEach(function(t){t.addEventListener("click",m)}),document.querySelectorAll(".etkm-add-image-btn-list").forEach(function(t){t.addEventListener("click",m)})}(t.data.kits):a.innerHTML="<p>Failed to load template kits.</p>"}).catch(t=>{a.innerHTML="<p>Failed to load template kits.</p>"})}function m(t){t.stopPropagation();const e=t.currentTarget.dataset.filename;s||(s=wp.media({title:"Select or Upload Image",button:{text:"Use this image"},multiple:!1,library:{type:"image"}})),s.off("select"),s.on("select",function(){const t=s.state().get("selection").first().toJSON();var n,a;n=e,a=t.id,fetch(etkm.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"etkm_upload_image",nonce:etkm.nonce,kit_filename:n,image_id:a})}).then(t=>t.json()).then(t=>{t.success?(f(t.data.message,"success"),l()):f(t.data.message||etkm.strings.imageUploadError,"error")}).catch(t=>{f(etkm.strings.imageUploadError,"error")})}),s.open()}function p(t){t.stopPropagation();const e=t.currentTarget,n=e.dataset.filename,a=e.innerHTML;e.disabled||(e.disabled=!0,e.innerHTML='<span class="spinner is-active" style="float: none; margin: 0 8px 0 0;"></span>Importing...',fetch(etkm.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"etkm_import_kit",nonce:etkm.nonce,filename:n})}).then(t=>t.json()).then(t=>{if(t.success){let e=t.data.message;t.data.imported&&t.data.imported.length>0&&(e+="<ul>",t.data.imported.forEach(function(t){e+="<li>"+k(t.title)+" ("+k(t.type)+")</li>"}),e+="</ul>"),f(e,"success")}else f(t.data.message||etkm.strings.importError,"error");e.disabled=!1,e.innerHTML=a}).catch(t=>{f(etkm.strings.importError,"error"),e.disabled=!1,e.innerHTML=a}))}function u(t){t.stopPropagation();const e=t.currentTarget,n=e.dataset.filename;if(!confirm(etkm.strings.deleteConfirm))return;const a=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="spinner is-active" style="float: none; margin: 0;"></span>',fetch(etkm.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"etkm_delete_kit",nonce:etkm.nonce,filename:n})}).then(t=>t.json()).then(t=>{t.success?(f(t.data.message,"success"),o.delete(n),l()):(f(t.data.message||"Failed to delete template kit.","error"),e.disabled=!1,e.innerHTML=a)}).catch(t=>{f("Failed to delete template kit.","error"),e.disabled=!1,e.innerHTML=a})}function f(t,e){const n=document.getElementById("etkm-notification");n&&(n.className="etkm-notification "+e,n.innerHTML="<p>"+t+"</p>",n.style.display="block",setTimeout(function(){n.style.display="none"},5e3))}function k(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}t&&e&&n&&a&&(l(),document.querySelectorAll(".etkm-view-btn").forEach(function(t){t.addEventListener("click",function(){const t=this.dataset.view;t!==i&&(i=t,document.querySelectorAll(".etkm-view-btn").forEach(t=>t.classList.remove("active")),this.classList.add("active"),function(t){"gallery"===t?(a.classList.remove("etkm-list-view"),a.classList.add("etkm-gallery-view")):(a.classList.remove("etkm-gallery-view"),a.classList.add("etkm-list-view")),l()}(t))})}),n.addEventListener("click",function(){e.click()}),e.addEventListener("change",function(t){t.target.files.length>0&&r(t.target.files[0])}),t.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),t.classList.add("drag-over")}),t.addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation(),t.classList.remove("drag-over")}),t.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),t.classList.remove("drag-over");const n=e.dataTransfer.files;n.length>0&&r(n[0])}))}();